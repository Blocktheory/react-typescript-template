{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { v4 as uuid } from '@lukeed/uuid';\nimport jar from 'js-cookie';\nimport { tld } from './tld';\nimport autoBind from '../../lib/bind-all';\nvar defaults = {\n  persist: true,\n  cookie: {\n    key: 'ajs_user_id',\n    oldKey: 'ajs_user'\n  },\n  localStorage: {\n    key: 'ajs_user_traits'\n  }\n};\n\nvar Store =\n/** @class */\nfunction () {\n  function Store() {\n    this.cache = {};\n  }\n\n  Store.prototype.get = function (key) {\n    return this.cache[key];\n  };\n\n  Store.prototype.set = function (key, value) {\n    this.cache[key] = value;\n    return value;\n  };\n\n  Store.prototype.remove = function (key) {\n    delete this.cache[key];\n  };\n\n  return Store;\n}();\n\nvar ONE_YEAR = 365;\n\nvar Cookie =\n/** @class */\nfunction (_super) {\n  __extends(Cookie, _super);\n\n  function Cookie(options) {\n    if (options === void 0) {\n      options = Cookie.defaults;\n    }\n\n    var _this = _super.call(this) || this;\n\n    _this.options = __assign(__assign({}, Cookie.defaults), options);\n    return _this;\n  }\n\n  Cookie.available = function () {\n    var cookieEnabled = window.navigator.cookieEnabled;\n\n    if (!cookieEnabled) {\n      jar.set('ajs:cookies', 'test');\n      cookieEnabled = document.cookie.includes('ajs:cookies');\n      jar.remove('ajs:cookies');\n    }\n\n    return cookieEnabled;\n  };\n\n  Object.defineProperty(Cookie, \"defaults\", {\n    get: function () {\n      return {\n        maxage: ONE_YEAR,\n        domain: tld(window.location.href),\n        path: '/',\n        sameSite: 'Lax'\n      };\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  Cookie.prototype.opts = function () {\n    return {\n      sameSite: this.options.sameSite,\n      expires: this.options.maxage,\n      domain: this.options.domain,\n      path: this.options.path,\n      secure: this.options.secure\n    };\n  };\n\n  Cookie.prototype.get = function (key) {\n    try {\n      var value = jar.get(key);\n\n      if (!value) {\n        return null;\n      }\n\n      try {\n        return JSON.parse(value);\n      } catch (e) {\n        return value;\n      }\n    } catch (e) {\n      return null;\n    }\n  };\n\n  Cookie.prototype.set = function (key, value) {\n    if (typeof value === 'string') {\n      jar.set(key, value, this.opts());\n    } else if (value === null) {\n      jar.remove(key, this.opts());\n    } else {\n      jar.set(key, JSON.stringify(value), this.opts());\n    }\n\n    return value;\n  };\n\n  Cookie.prototype.remove = function (key) {\n    return jar.remove(key, this.opts());\n  };\n\n  return Cookie;\n}(Store);\n\nexport { Cookie };\n\nvar NullStorage =\n/** @class */\nfunction (_super) {\n  __extends(NullStorage, _super);\n\n  function NullStorage() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    _this.get = function (_key) {\n      return null;\n    };\n\n    _this.set = function (_key, _val) {\n      return null;\n    };\n\n    _this.remove = function (_key) {};\n\n    return _this;\n  }\n\n  return NullStorage;\n}(Store);\n\nvar LocalStorage =\n/** @class */\nfunction (_super) {\n  __extends(LocalStorage, _super);\n\n  function LocalStorage() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  LocalStorage.available = function () {\n    var test = 'test';\n\n    try {\n      localStorage.setItem(test, test);\n      localStorage.removeItem(test);\n      return true;\n    } catch (e) {\n      return false;\n    }\n  };\n\n  LocalStorage.prototype.get = function (key) {\n    var val = localStorage.getItem(key);\n\n    if (val) {\n      try {\n        return JSON.parse(val);\n      } catch (e) {\n        return JSON.parse(JSON.stringify(val));\n      }\n    }\n\n    return null;\n  };\n\n  LocalStorage.prototype.set = function (key, value) {\n    try {\n      localStorage.setItem(key, JSON.stringify(value));\n    } catch (_a) {\n      console.warn(\"Unable to set \".concat(key, \" in localStorage, storage may be full.\"));\n    }\n\n    return value;\n  };\n\n  LocalStorage.prototype.remove = function (key) {\n    return localStorage.removeItem(key);\n  };\n\n  return LocalStorage;\n}(Store);\n\nexport { LocalStorage };\n\nvar User =\n/** @class */\nfunction () {\n  function User(options, cookieOptions) {\n    if (options === void 0) {\n      options = defaults;\n    }\n\n    var _this = this;\n\n    var _a, _b, _c, _d;\n\n    this.options = {};\n\n    this.id = function (id) {\n      var _a, _b;\n\n      if (_this.options.disable) {\n        return null;\n      }\n\n      var prevId = _this.chainGet(_this.idKey);\n\n      if (id !== undefined) {\n        _this.trySet(_this.idKey, id);\n\n        var changingIdentity = id !== prevId && prevId !== null && id !== null;\n\n        if (changingIdentity) {\n          _this.anonymousId(null);\n        }\n      }\n\n      return (_b = (_a = _this.chainGet(_this.idKey)) !== null && _a !== void 0 ? _a : _this.cookies.get(defaults.cookie.oldKey)) !== null && _b !== void 0 ? _b : null;\n    };\n\n    this.anonymousId = function (id) {\n      var _a, _b;\n\n      if (_this.options.disable) {\n        return null;\n      }\n\n      if (id === undefined) {\n        var val = (_a = _this.chainGet(_this.anonKey)) !== null && _a !== void 0 ? _a : (_b = _this.legacySIO()) === null || _b === void 0 ? void 0 : _b[0];\n\n        if (val) {\n          return val;\n        }\n      }\n\n      if (id === null) {\n        _this.trySet(_this.anonKey, null);\n\n        return _this.chainGet(_this.anonKey);\n      }\n\n      _this.trySet(_this.anonKey, id !== null && id !== void 0 ? id : uuid());\n\n      return _this.chainGet(_this.anonKey);\n    };\n\n    this.traits = function (traits) {\n      var _a, _b;\n\n      if (_this.options.disable) {\n        return;\n      }\n\n      if (traits === null) {\n        traits = {};\n      }\n\n      if (traits) {\n        _this.mem.set(_this.traitsKey, traits !== null && traits !== void 0 ? traits : {});\n\n        _this.localStorage.set(_this.traitsKey, traits !== null && traits !== void 0 ? traits : {});\n      }\n\n      return (_b = (_a = _this.localStorage.get(_this.traitsKey)) !== null && _a !== void 0 ? _a : _this.mem.get(_this.traitsKey)) !== null && _b !== void 0 ? _b : {};\n    };\n\n    this.options = options;\n    this.cookieOptions = cookieOptions;\n    this.idKey = (_b = (_a = options.cookie) === null || _a === void 0 ? void 0 : _a.key) !== null && _b !== void 0 ? _b : defaults.cookie.key;\n    this.traitsKey = (_d = (_c = options.localStorage) === null || _c === void 0 ? void 0 : _c.key) !== null && _d !== void 0 ? _d : defaults.localStorage.key;\n    this.anonKey = 'ajs_anonymous_id';\n    var isDisabled = options.disable === true;\n    var shouldPersist = options.persist !== false;\n    this.localStorage = isDisabled || options.localStorageFallbackDisabled || !shouldPersist || !LocalStorage.available() ? new NullStorage() : new LocalStorage();\n    this.cookies = !isDisabled && shouldPersist && Cookie.available() ? new Cookie(cookieOptions) : new NullStorage();\n    this.mem = isDisabled ? new NullStorage() : new Store();\n    var legacyUser = this.cookies.get(defaults.cookie.oldKey);\n\n    if (legacyUser) {\n      legacyUser.id && this.id(legacyUser.id);\n      legacyUser.traits && this.traits(legacyUser.traits);\n    }\n\n    autoBind(this);\n  }\n\n  User.prototype.chainGet = function (key) {\n    var _a, _b, _c;\n\n    var val = (_c = (_b = (_a = this.localStorage.get(key)) !== null && _a !== void 0 ? _a : this.cookies.get(key)) !== null && _b !== void 0 ? _b : this.mem.get(key)) !== null && _c !== void 0 ? _c : null;\n    return this.trySet(key, typeof val === 'number' ? val.toString() : val);\n  };\n\n  User.prototype.trySet = function (key, value) {\n    this.localStorage.set(key, value);\n    this.cookies.set(key, value);\n    this.mem.set(key, value);\n    return value;\n  };\n\n  User.prototype.chainClear = function (key) {\n    this.localStorage.remove(key);\n    this.cookies.remove(key);\n    this.mem.remove(key);\n  };\n\n  User.prototype.legacySIO = function () {\n    var val = this.cookies.get('_sio');\n\n    if (!val) {\n      return null;\n    }\n\n    var _a = val.split('----'),\n        anon = _a[0],\n        user = _a[1];\n\n    return [anon, user];\n  };\n\n  User.prototype.identify = function (id, traits) {\n    if (this.options.disable) {\n      return;\n    }\n\n    traits = traits !== null && traits !== void 0 ? traits : {};\n    var currentId = this.id();\n\n    if (currentId === null || currentId === id) {\n      traits = __assign(__assign({}, this.traits()), traits);\n    }\n\n    if (id) {\n      this.id(id);\n    }\n\n    this.traits(traits);\n  };\n\n  User.prototype.logout = function () {\n    this.anonymousId(null);\n    this.id(null);\n    this.traits({});\n  };\n\n  User.prototype.reset = function () {\n    this.logout();\n    this.chainClear(this.idKey);\n    this.chainClear(this.anonKey);\n    this.chainClear(this.traitsKey);\n  };\n\n  User.prototype.load = function () {\n    return new User(this.options, this.cookieOptions);\n  };\n\n  User.prototype.save = function () {\n    return true;\n  };\n\n  User.defaults = defaults;\n  return User;\n}();\n\nexport { User };\nvar groupDefaults = {\n  persist: true,\n  cookie: {\n    key: 'ajs_group_id'\n  },\n  localStorage: {\n    key: 'ajs_group_properties'\n  }\n};\n\nvar Group =\n/** @class */\nfunction (_super) {\n  __extends(Group, _super);\n\n  function Group(options, cookie) {\n    if (options === void 0) {\n      options = groupDefaults;\n    }\n\n    var _this = _super.call(this, options, cookie) || this;\n\n    _this.anonymousId = function (_id) {\n      return undefined;\n    };\n\n    autoBind(_this);\n    return _this;\n  }\n\n  return Group;\n}(User);\n\nexport { Group };","map":{"version":3,"sources":["/Users/apple/Sites/react-typescript-template/node_modules/@segment/analytics-next/src/core/user/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { v4 as uuid } from '@lukeed/uuid'\nimport jar from 'js-cookie'\nimport { Traits } from '../events'\nimport { tld } from './tld'\nimport autoBind from '../../lib/bind-all'\n\nexport type ID = string | null | undefined\n\nexport interface UserOptions {\n  /**\n   * Disables storing any data about the user.\n   */\n  disable?: boolean\n  localStorageFallbackDisabled?: boolean\n  persist?: boolean\n\n  cookie?: {\n    key?: string\n    oldKey?: string\n  }\n\n  localStorage?: {\n    key: string\n  }\n}\n\nconst defaults = {\n  persist: true,\n  cookie: {\n    key: 'ajs_user_id',\n    oldKey: 'ajs_user',\n  },\n  localStorage: {\n    key: 'ajs_user_traits',\n  },\n}\n\nclass Store {\n  private cache: Record<string, unknown> = {}\n\n  get<T>(key: string): T | null {\n    return this.cache[key] as T | null\n  }\n\n  set<T>(key: string, value: T | null): T | null {\n    this.cache[key] = value\n    return value\n  }\n\n  remove(key: string): void {\n    delete this.cache[key]\n  }\n}\n\nconst ONE_YEAR = 365\n\nexport class Cookie extends Store {\n  static available(): boolean {\n    let cookieEnabled = window.navigator.cookieEnabled\n\n    if (!cookieEnabled) {\n      jar.set('ajs:cookies', 'test')\n      cookieEnabled = document.cookie.includes('ajs:cookies')\n      jar.remove('ajs:cookies')\n    }\n\n    return cookieEnabled\n  }\n\n  static get defaults(): CookieOptions {\n    return {\n      maxage: ONE_YEAR,\n      domain: tld(window.location.href),\n      path: '/',\n      sameSite: 'Lax',\n    }\n  }\n\n  private options: Required<CookieOptions>\n\n  constructor(options: CookieOptions = Cookie.defaults) {\n    super()\n    this.options = {\n      ...Cookie.defaults,\n      ...options,\n    } as Required<CookieOptions>\n  }\n\n  private opts(): jar.CookieAttributes {\n    return {\n      sameSite: this.options.sameSite as jar.CookieAttributes['sameSite'],\n      expires: this.options.maxage,\n      domain: this.options.domain,\n      path: this.options.path,\n      secure: this.options.secure,\n    }\n  }\n\n  get<T>(key: string): T | null {\n    try {\n      const value = jar.get(key)\n\n      if (!value) {\n        return null\n      }\n\n      try {\n        return JSON.parse(value)\n      } catch (e) {\n        return value as unknown as T\n      }\n    } catch (e) {\n      return null\n    }\n  }\n\n  set<T>(key: string, value: T): T | null {\n    if (typeof value === 'string') {\n      jar.set(key, value, this.opts())\n    } else if (value === null) {\n      jar.remove(key, this.opts())\n    } else {\n      jar.set(key, JSON.stringify(value), this.opts())\n    }\n    return value\n  }\n\n  remove(key: string): void {\n    return jar.remove(key, this.opts())\n  }\n}\n\nclass NullStorage extends Store {\n  get = (_key: string): null => null\n  set = (_key: string, _val: unknown): null => null\n  remove = (_key: string): void => {}\n}\n\nexport class LocalStorage extends Store {\n  static available(): boolean {\n    const test = 'test'\n    try {\n      localStorage.setItem(test, test)\n      localStorage.removeItem(test)\n      return true\n    } catch (e) {\n      return false\n    }\n  }\n\n  get<T>(key: string): T | null {\n    const val = localStorage.getItem(key)\n    if (val) {\n      try {\n        return JSON.parse(val)\n      } catch (e) {\n        return JSON.parse(JSON.stringify(val))\n      }\n    }\n    return null\n  }\n\n  set<T>(key: string, value: T): T | null {\n    try {\n      localStorage.setItem(key, JSON.stringify(value))\n    } catch {\n      console.warn(`Unable to set ${key} in localStorage, storage may be full.`)\n    }\n\n    return value\n  }\n\n  remove(key: string): void {\n    return localStorage.removeItem(key)\n  }\n}\n\nexport interface CookieOptions {\n  maxage?: number\n  domain?: string\n  path?: string\n  secure?: boolean\n  sameSite?: string\n}\n\nexport class User {\n  static defaults = defaults\n\n  private cookies: Store\n  private localStorage: Store\n  private mem: Store\n\n  private idKey: string\n  private traitsKey: string\n  private anonKey: string\n  private cookieOptions?: CookieOptions\n\n  options: UserOptions = {}\n\n  constructor(options: UserOptions = defaults, cookieOptions?: CookieOptions) {\n    this.options = options\n    this.cookieOptions = cookieOptions\n\n    this.idKey = options.cookie?.key ?? defaults.cookie.key\n    this.traitsKey = options.localStorage?.key ?? defaults.localStorage.key\n    this.anonKey = 'ajs_anonymous_id'\n\n    const isDisabled = options.disable === true\n    const shouldPersist = options.persist !== false\n\n    this.localStorage =\n      isDisabled ||\n      options.localStorageFallbackDisabled ||\n      !shouldPersist ||\n      !LocalStorage.available()\n        ? new NullStorage()\n        : new LocalStorage()\n\n    this.cookies =\n      !isDisabled && shouldPersist && Cookie.available()\n        ? new Cookie(cookieOptions)\n        : new NullStorage()\n\n    this.mem = isDisabled ? new NullStorage() : new Store()\n\n    const legacyUser = this.cookies.get<{ id?: string; traits?: Traits }>(\n      defaults.cookie.oldKey\n    )\n    if (legacyUser) {\n      legacyUser.id && this.id(legacyUser.id)\n      legacyUser.traits && this.traits(legacyUser.traits)\n    }\n    autoBind(this)\n  }\n\n  private chainGet<T>(key: string): T | null {\n    const val =\n      this.localStorage.get(key) ??\n      this.cookies.get(key) ??\n      this.mem.get(key) ??\n      null\n\n    return this.trySet(\n      key,\n      typeof val === 'number' ? val.toString() : val\n    ) as T | null\n  }\n\n  private trySet<T>(key: string, value: T): T | null {\n    this.localStorage.set(key, value)\n    this.cookies.set(key, value)\n    this.mem.set(key, value)\n    return value\n  }\n\n  private chainClear(key: string): void {\n    this.localStorage.remove(key)\n    this.cookies.remove(key)\n    this.mem.remove(key)\n  }\n\n  id = (id?: ID): ID => {\n    if (this.options.disable) {\n      return null\n    }\n\n    const prevId = this.chainGet(this.idKey)\n\n    if (id !== undefined) {\n      this.trySet(this.idKey, id)\n\n      const changingIdentity = id !== prevId && prevId !== null && id !== null\n      if (changingIdentity) {\n        this.anonymousId(null)\n      }\n    }\n\n    return (\n      this.chainGet(this.idKey) ??\n      this.cookies.get(defaults.cookie.oldKey) ??\n      null\n    )\n  }\n\n  private legacySIO(): [string, string] | null {\n    const val = this.cookies.get('_sio') as string\n    if (!val) {\n      return null\n    }\n    const [anon, user] = val.split('----')\n    return [anon, user]\n  }\n\n  anonymousId = (id?: ID): ID => {\n    if (this.options.disable) {\n      return null\n    }\n\n    if (id === undefined) {\n      const val = this.chainGet<ID>(this.anonKey) ?? this.legacySIO()?.[0]\n\n      if (val) {\n        return val\n      }\n    }\n\n    if (id === null) {\n      this.trySet(this.anonKey, null)\n      return this.chainGet(this.anonKey)\n    }\n\n    this.trySet(this.anonKey, id ?? uuid())\n    return this.chainGet(this.anonKey)\n  }\n\n  traits = (traits?: Traits | null): Traits | undefined => {\n    if (this.options.disable) {\n      return\n    }\n\n    if (traits === null) {\n      traits = {}\n    }\n\n    if (traits) {\n      this.mem.set(this.traitsKey, traits ?? {})\n      this.localStorage.set(this.traitsKey, traits ?? {})\n    }\n\n    return (\n      this.localStorage.get(this.traitsKey) ??\n      this.mem.get(this.traitsKey) ??\n      {}\n    )\n  }\n\n  identify(id?: ID, traits?: Traits): void {\n    if (this.options.disable) {\n      return\n    }\n\n    traits = traits ?? {}\n    const currentId = this.id()\n\n    if (currentId === null || currentId === id) {\n      traits = {\n        ...this.traits(),\n        ...traits,\n      }\n    }\n\n    if (id) {\n      this.id(id)\n    }\n\n    this.traits(traits)\n  }\n\n  logout(): void {\n    this.anonymousId(null)\n    this.id(null)\n    this.traits({})\n  }\n\n  reset(): void {\n    this.logout()\n    this.chainClear(this.idKey)\n    this.chainClear(this.anonKey)\n    this.chainClear(this.traitsKey)\n  }\n\n  load(): User {\n    return new User(this.options, this.cookieOptions)\n  }\n\n  save(): boolean {\n    return true\n  }\n}\n\nconst groupDefaults: UserOptions = {\n  persist: true,\n  cookie: {\n    key: 'ajs_group_id',\n  },\n  localStorage: {\n    key: 'ajs_group_properties',\n  },\n}\n\nexport class Group extends User {\n  constructor(options: UserOptions = groupDefaults, cookie?: CookieOptions) {\n    super(options, cookie)\n    autoBind(this)\n  }\n\n  anonymousId = (_id?: ID): ID => {\n    return undefined\n  }\n}\n"]},"metadata":{},"sourceType":"module"}